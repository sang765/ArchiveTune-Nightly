name: Update Release Notes

on:
  repository_dispatch:
    types: [update-release-notes]

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Generate changelog
        run: bun run scripts/generate-changelog.ts

      - name: Get Date
        id: date
        run: echo "date=$(date +'%Y/%m/%d')" >> $GITHUB_OUTPUT

      - name: Get Time
        id: time
        run: echo "time=$(date +'%I:%M:%S %p')" >> $GITHUB_OUTPUT

      - name: Read changelog
        id: changelog
        run: |
          CHANGELOG=$(cat changelog.md)
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Update release notes
        run: |
          BODY=$(cat << EOF
          Release **ArchiveTune Nightly** artifact, generated on **${{ steps.date.outputs.date }} - ${{ steps.time.outputs.time }} (UTC +0)**

          ${{ steps.changelog.outputs.changelog }}
          
          > [!NOTE]  
          > If this version broken something, please react ðŸ‘€ in this release. Thank you.
          EOF
          )
          
          gh release edit ${{ github.event.client_payload.new_version }} --notes "$BODY"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Update history
        run: |
          RESPONSE=$(curl -s https://api.github.com/repos/koiverse/ArchiveTune/commits/dev)
          LATEST_SHA=$(echo $RESPONSE | jq -r '.sha')
          MESSAGE=$(echo $RESPONSE | jq -r '.commit.message')
          
          mkdir -p history
          
          if [ -f history/commit.json ]; then
             jq --arg sha "$LATEST_SHA" --arg msg "$MESSAGE" '.commit.sha = $sha | .commit.message = $msg' history/commit.json > tmp.json && mv tmp.json history/commit.json
          else
             echo "{\"commit\": {\"sha\": \"$LATEST_SHA\", \"message\": \"$MESSAGE\", \"repository\": \"koiverse/ArchiveTune\", \"branch\": \"dev\"}}" > history/commit.json
          fi

      - name: Commit and push
        run: |
          git config --global user.name 'sang765'
          git config --global user.email 'bemimnitran@gmail.com'
          git add history/commit.json
          git commit -m "chore: update history pointer [skip ci]" || echo "No changes to commit"
          git push
