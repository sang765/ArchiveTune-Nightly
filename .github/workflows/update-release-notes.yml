name: Update Release Notes

# Changelog generation supports two engines:
# - typescript (default): Uses Bun to run scripts/generate-changelog.ts
# - kotlin: Uses Kotlin to run scripts/generate-changelog.main.kts
on:
  repository_dispatch:
    types: [update-release-notes]
  workflow_dispatch:
    inputs:
      changelog_engine:
        description: 'Changelog generation engine'
        required: false
        default: 'typescript'
        type: choice
        options:
          - typescript
          - kotlin

env:
  # Set changelog engine from input, default to typescript
  CHANGELOG_ENGINE: ${{ github.event.client_payload.changelog_engine || github.event.inputs.changelog_engine || 'typescript' }}

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # Setup Bun for TypeScript changelog generation (runs when engine is typescript)
      - name: Setup Bun
        if: env.CHANGELOG_ENGINE == 'typescript'
        uses: oven-sh/setup-bun@v2.1.2

      # Setup Java for Kotlin changelog generation (runs when engine is kotlin)
      - name: Setup Java
        if: env.CHANGELOG_ENGINE == 'kotlin'
        uses: actions/setup-java@v5.2.0
        with:
          distribution: temurin
          java-version: '21'

      # Setup Kotlin for Kotlin changelog generation (runs when engine is kotlin)
      - name: Setup Kotlin
        if: env.CHANGELOG_ENGINE == 'kotlin'
        run: |
          # Install Kotlin compiler manually using SDKMAN or download directly
          curl -s "https://get.sdkman.io" | bash
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          sdk install kotlin 1.9.24
          echo "$HOME/.sdkman/candidates/kotlin/current/bin" >> $GITHUB_PATH

      - name: Generate changelog (TypeScript)
        if: env.CHANGELOG_ENGINE == 'typescript'
        run: bun run scripts/generate-changelog.ts

      - name: Generate changelog (Kotlin)
        if: env.CHANGELOG_ENGINE == 'kotlin'
        run: kotlin scripts/generate-changelog.main.kts

      - name: Get Date
        id: date
        run: echo "date=$(date +'%Y/%m/%d')" >> $GITHUB_OUTPUT

      - name: Get Time
        id: time
        run: echo "time=$(date +'%I:%M:%S %p')" >> $GITHUB_OUTPUT
      
      - name: Get Release Assets
        id: assets
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          RELEASE_TAG: ${{ github.event.client_payload.new_version }}
        run: |
          DOWNLOAD_TABLE="No APK files found in this release."
          
          if [ -n "$RELEASE_TAG" ]; then
            echo "Fetching assets for release: $RELEASE_TAG"
            
            RELEASE_JSON=$(gh release view "$RELEASE_TAG" --json assets)
            
            DOWNLOAD_TABLE=$(echo "$RELEASE_JSON" | jq -r '
              .assets[] | 
              select(.name | endswith(".apk")) |
              "| \(
                if .name == "ArchiveTune-Nightly.apk" then "**Universal**"
                elif .name | test("arm64"; "i") then "**arm64** (64-bit Phone)"
                elif .name | test("armeabi"; "i") then "**armeabi** (32-bit Phone)"
                elif .name | test("x86_64"; "i") then "**x86_64** (64-bit Tablet)"
                elif .name | test("x86"; "i") then "**x86** (32-bit Tablet)"
                else .name end
              ) | \( (.size / 1048576) | floor * 100 / 100 ) MB | [\(.name)](\(.url)) |'
            )
            
            if [ -n "$DOWNLOAD_TABLE" ]; then
              DOWNLOAD_TABLE="| **ABI** | **Size** | **Download** |
              |-----|-----|-----|
              $DOWNLOAD_TABLE"
              fi
            fi
          
          {
            echo "download_table<<EOF"
            echo "$DOWNLOAD_TABLE"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Read changelog
        id: changelog
        run: |
          CHANGELOG=$(cat changelog.md)
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Update release notes
        run: |
          BODY=$(cat << 'EOF'
          Release **ArchiveTune Nightly** artifact, generated on **${{ steps.date.outputs.date }} - ${{ steps.time.outputs.time }} (UTC +0)**

          ${{ steps.changelog.outputs.changelog }}
          
          ## ðŸ“¦ Download

          ${{ steps.assets.outputs.download_table }}
          
          > [!NOTE]  
          > If this version broken something, please react ðŸ‘€ in this release. Thank you.
          EOF
          )
          
          gh release edit ${{ github.event.client_payload.new_version }} --notes "$BODY"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Update history
        run: |
          RESPONSE=$(curl -s https://api.github.com/repos/koiverse/ArchiveTune/commits/dev)
          LATEST_SHA=$(echo $RESPONSE | jq -r '.sha')
          MESSAGE=$(echo $RESPONSE | jq -r '.commit.message')
          
          mkdir -p history
          
          if [ -f history/commit.json ]; then
             jq --arg sha "$LATEST_SHA" --arg msg "$MESSAGE" '.commit.sha = $sha | .commit.message = $msg' history/commit.json > tmp.json && mv tmp.json history/commit.json
          else
             echo "{\"commit\": {\"sha\": \"$LATEST_SHA\", \"message\": \"$MESSAGE\", \"repository\": \"koiverse/ArchiveTune\", \"branch\": \"dev\"}}" > history/commit.json
          fi

      - name: Commit and push
        run: |
         git config --global user.name 'sang765'
         git config --global user.email 'bemimnitran@gmail.com'
         git add history/commit.json
         git commit -m "chore: update history pointer [skip ci]" || echo "No changes to commit"
         git pull --rebase origin main
         git push
