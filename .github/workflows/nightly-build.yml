name: Nightly Build

on:
  repository_dispatch:
    types: [trigger-nightly]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ env.NEW_VERSION }}
      new_version_code: ${{ env.NEW_VERSION_CODE }}
      changelog: ${{ steps.changelog.outputs.changelog }}
      date: ${{ steps.date.outputs.date }}
      time: ${{ steps.time.outputs.time }}
    strategy:
      matrix:
        abi: [ 'arm64', 'armeabi', 'x86', 'x86_64', 'universal' ]

    steps:
      - uses: actions/checkout@v6
        with:
          repository: koiverse/ArchiveTune
          ref: dev

      - name: Generate changelog
        id: changelog
        run: |
          CHANGELOG=$(git log --pretty=format="- ([%h](https://github.com/koiverse/ArchiveTune/commit/%H)): **\"%s\"** by **@%an**" --since="1 day ago" --no-merges)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "## Changelog" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get Date
        id: date
        run: echo "date=$(date +'%Y/%m/%d')" >> $GITHUB_OUTPUT

      - name: Get Time
        id: time
        run: echo "time=$(date +'%I:%M:%S %p')" >> $GITHUB_OUTPUT

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set Up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-cleanup: on-success

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode keystore
        run: echo "$KEYSTORE_B64" | base64 -d > release.keystore

      - name: Update version name and code for nightly build
        run: |
          # original values
          ORIGINAL_VERSION=$(grep 'versionName = ' app/build.gradle.kts | sed 's/.*versionName = "\(.*\)"/\1/')
          ORIGINAL_VERSION_CODE=$(grep 'versionCode = ' app/build.gradle.kts | head -n1 | sed 's/.*versionCode = \(.*\)/\1/' | tr -d '[:space:]')

          # new versionName (prefix N + YYYYMMDD)
          NEW_VERSION="N$(date +%Y%m%d)"

          # prefer CI build number; fallback to date if not available
          NEW_VERSION_CODE="${GITHUB_RUN_NUMBER}"
          if [ -z "$NEW_VERSION_CODE" ]; then
            NEW_VERSION_CODE=$(date +%Y%m%d)
          fi

          # apply replacements
          sed -i "s/versionName = \"$ORIGINAL_VERSION\"/versionName = \"$NEW_VERSION\"/" app/build.gradle.kts
          sed -i "s/versionCode = $ORIGINAL_VERSION_CODE/versionCode = $NEW_VERSION_CODE/" app/build.gradle.kts

          echo "Changed version from $ORIGINAL_VERSION ($ORIGINAL_VERSION_CODE) to $NEW_VERSION ($NEW_VERSION_CODE)"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "NEW_VERSION_CODE=$NEW_VERSION_CODE" >> $GITHUB_ENV

      - name: Update app name, package, and namespace
        run: |
          sed -i 's/applicationId = "moe.koiverse.archivetune"/applicationId = "moe.koiverse.archivetune.nightly"/' app/build.gradle.kts
          sed -i 's/namespace = "moe.koiverse.archivetune"/namespace = "moe.koiverse.archivetune.nightly"/' app/build.gradle.kts
          sed -i 's/ArchiveTune Debug/ArchiveTune Nightly Debug/' app/src/debug/res/values/app_name.xml
          sed -i 's/ArchiveTune/ArchiveTune Nightly/' app/src/main/res/values/app_name.xml

      - name: Set default update channel to nightly
        run: sed -i 's/defaultValue = UpdateChannel.STABLE/defaultValue = UpdateChannel.NIGHTLY/' app/src/main/kotlin/moe/koiverse/archivetune/ui/screens/settings/UpdateScreen.kt

      - name: Update about screen to show ABI_NIGHTLY label
        run: |
          sed -i 's/text = BuildConfig.ARCHITECTURE.uppercase(),/text = "${BuildConfig.ARCHITECTURE.uppercase()}_NIGHTLY",/' app/src/main/kotlin/moe/koiverse/archivetune/ui/screens/settings/AboutScreen.kt

      - name: Update update check URLs for fork
        run: |
          sed -i 's|https://api.github.com/repos/koiverse/ArchiveTune/releases|https://api.github.com/repos/sang765/ArchiveTune-Nightly/releases|g' app/src/main/kotlin/moe/koiverse/archivetune/utils/Updater.kt
          sed -i 's|https://github.com/koiverse/ArchiveTune/releases|https://github.com/sang765/ArchiveTune-Nightly/releases|g' app/src/main/kotlin/moe/koiverse/archivetune/utils/Updater.kt
          sed -i 's/ArchiveTune.apk/ArchiveTune-Nightly.apk/' app/src/main/kotlin/moe/koiverse/archivetune/utils/Updater.kt
          sed -i 's/app-${architecture}-release.apk/app-${architecture}-nightly.apk/' app/src/main/kotlin/moe/koiverse/archivetune/utils/Updater.kt

      - name: Build Release APK
        run: ./gradlew assemble${{ matrix.abi }}Release
        env:
          PULL_REQUEST: 'false'
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          LASTFM_SECRET: ${{ secrets.LASTFM_SECRET }}

      - name: Resolve release output directory
        id: release_dir
        shell: bash
        run: |
          set -euo pipefail
          ABI="${{ matrix.abi }}"
          ABI_LOWER=$(echo "$ABI" | tr '[:upper:]' '[:lower:]')
          CANDIDATES=(
            "app/build/outputs/apk/${ABI_LOWER}/release"
            "app/build/outputs/apk/${ABI_LOWER}Release/release"
          )
          for d in "${CANDIDATES[@]}"; do
            if [ -d "$d" ]; then
              echo "release_dir=$d" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          done

          FOUND_METADATA="$(
            find app/build/outputs/apk -type f -name "output-metadata.json" \
              \( \
                -path "*/${ABI_LOWER}/release/output-metadata.json" -o \
                -path "*/${ABI_LOWER}Release/release/output-metadata.json" -o \
                -path "*/${ABI_LOWER}/*/release/output-metadata.json" -o \
                -path "*/${ABI_LOWER}Release/*/release/output-metadata.json" \
              \) \
              | head -n 1 || true
          )"
          if [ -n "${FOUND_METADATA:-}" ]; then
            echo "release_dir=$(dirname "$FOUND_METADATA")" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Could not resolve APK release output directory for ABI=$ABI"
          find app/build/outputs/apk -maxdepth 6 -type d -print || true
          exit 1

      - name: Sign APK
        uses: ilharp/sign-android-release@v2.0.0
        with:
          releaseDir: ${{ steps.release_dir.outputs.release_dir }}/
          signingKey: ${{ secrets.KEYSTORE_B64 }}
          keyAlias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
          buildToolsVersion: 35.0.0

      - name: Move and rename signed APKs
        run: |
          RELEASE_DIR="${{ steps.release_dir.outputs.release_dir }}"
          mkdir -p "$RELEASE_DIR/out"
          ABI="${{ matrix.abi }}"
          if [ "$ABI" = "Universal" ]; then
            find "$RELEASE_DIR" -name "*-signed.apk" -o -name "*-unsigned-signed.apk" | xargs -I{} mv {} "$RELEASE_DIR/out/ArchiveTune-Nightly.apk"
          else
            ABI_LOWER=$(echo "$ABI" | tr '[:upper:]' '[:lower:]')
            find "$RELEASE_DIR" -name "*-signed.apk" -o -name "*-unsigned-signed.apk" | xargs -I{} mv {} "$RELEASE_DIR/out/app-${ABI_LOWER}-nightly.apk"
          fi

      - name: Upload APKs
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.abi == 'Universal' && 'ArchiveTune-Nightly' || format('app-{0}-nightly', matrix.abi) }}
          path: ${{ steps.release_dir.outputs.release_dir }}/out/${{ matrix.abi == 'Universal' && 'ArchiveTune-Nightly.apk' || format('app-{0}-nightly.apk', matrix.abi) }}

  create-release:
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          repository: sang765/ArchiveTune-Nightly
          ref: main
          fetch-depth: 0

      - name: Download all APKs
        uses: actions/download-artifact@v7
        with:
          path: downloaded_artifacts/

      - name: Create nightly release
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: ${{ needs.build.outputs.new_version }}
          name: ${{ needs.build.outputs.new_version }}
          body: |
            Release **ArchiveTune Nightly** artifact, generated on **${{ needs.build.outputs.date }} - ${{ needs.build.outputs.time }} (UTC +0)**

            ${{ needs.build.outputs.changelog }}
          files: |
            downloaded_artifacts/**/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Trigger update release notes
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "update-release-notes", "client_payload": {"new_version": "${{ needs.build.outputs.new_version }}", "changelog_engine": "kotlin"}}'

      - name: Notify on failure
        if: failure()
        run: |
          echo "Build failed on $(date)"
