name: Nightly Build

on:
  repository_dispatch:
    types: [trigger-nightly]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Read last commit info
        id: read_info
        run: |
          if [ ! -f history/commit.json ]; then
            echo "last_sha=" >> $GITHUB_OUTPUT
            echo "last_message=" >> $GITHUB_OUTPUT
            echo "last_repo=" >> $GITHUB_OUTPUT
          else
            LAST_SHA=$(jq -r '.commit.sha' history/commit.json)
            LAST_MESSAGE=$(jq -r '.commit.message' history/commit.json)
            LAST_REPO=$(jq -r '.commit.repository' history/commit.json)
            echo "last_sha=$LAST_SHA" >> $GITHUB_OUTPUT
            echo "last_message=$LAST_MESSAGE" >> $GITHUB_OUTPUT
            echo "last_repo=$LAST_REPO" >> $GITHUB_OUTPUT
          fi

      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          repository: koiverse/ArchiveTune
          ref: dev

      - name: Check for new commits
        id: check
        run: |
          LAST_SHA="${{ steps.read_info.outputs.last_sha }}"
          if [ -z "$LAST_SHA" ]; then
            echo "No previous SHA found, assuming first run"
            echo "commit_count=1" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            COMMIT_COUNT=$(git log --oneline $LAST_SHA..HEAD | wc -l)
            echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
            if [ "$COMMIT_COUNT" -eq 0 ]; then
              echo "No new commits since $LAST_SHA, skipping build"
              echo "skip=true" >> $GITHUB_OUTPUT
            else
              echo "Found $COMMIT_COUNT new commits since $LAST_SHA"
              echo "skip=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Set up JDK 21
        if: steps.check.outputs.skip == 'false'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        if: steps.check.outputs.skip == 'false'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        if: steps.check.outputs.skip == 'false'
        run: chmod +x gradlew

      - name: Update version name for nightly build
        if: steps.check.outputs.skip == 'false'
        run: |
          ORIGINAL_VERSION=$(grep 'versionName = ' app/build.gradle.kts | sed 's/.*versionName = "\(.*\)"/\1/')
          NEW_VERSION="N$(date +%Y%m%d)"
          sed -i "s/versionName = \"$ORIGINAL_VERSION\"/versionName = \"$NEW_VERSION\"/" app/build.gradle.kts
          echo "Changed version from $ORIGINAL_VERSION to $NEW_VERSION"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Update app name and package
        if: steps.check.outputs.skip == 'false'
        run: |
          sed -i 's/applicationIdSuffix = ".debug"/applicationIdSuffix = ".nightly"/' app/build.gradle.kts
          sed -i 's/ArchiveTune Debug/ArchiveTune Nightly/' app/src/debug/res/values/app_name.xml
          sed -i 's/ArchiveTune/ArchiveTune Nightly/' app/src/main/res/values/app_name.xml
          sed -i '/buildTypes {/a\    create("nightly") {\n        initWith(getByName("debug"))\n    }' app/build.gradle.kts

      - name: Set default update channel to nightly
        if: steps.check.outputs.skip == 'false'
        run: sed -i 's/defaultValue = UpdateChannel.STABLE/defaultValue = UpdateChannel.NIGHTLY/' app/src/main/kotlin/moe/koiverse/archivetune/ui/screens/settings/UpdateScreen.kt

      - name: Update about screen debug label to nightly
        if: steps.check.outputs.skip == 'false'
        run: sed -i 's/text = "DEBUG"/text = "NIGHTLY"/' app/src/main/kotlin/moe/koiverse/archivetune/ui/screens/settings/AboutScreen.kt

      - name: Update update check URLs for fork
        if: steps.check.outputs.skip == 'false'
        run: |
          sed -i 's|https://api.github.com/repos/koiverse/ArchiveTune/releases|https://api.github.com/repos/sang765/ArchiveTune-Nightly/releases|g' app/src/main/kotlin/moe/koiverse/archivetune/utils/Updater.kt
          sed -i 's|https://github.com/koiverse/ArchiveTune/releases|https://github.com/sang765/ArchiveTune-Nightly/releases|g' app/src/main/kotlin/moe/koiverse/archivetune/utils/Updater.kt
          sed -i 's/ArchiveTune.apk/ArchiveTune-Nightly.apk/' app/src/main/kotlin/moe/koiverse/archivetune/utils/Updater.kt
          sed -i 's/app-${architecture}-release.apk/app-${architecture}-nightly.apk/' app/src/main/kotlin/moe/koiverse/archivetune/utils/Updater.kt

      - name: Build nightly APKs
        if: steps.check.outputs.skip == 'false'
        run: ./gradlew assembleUniversalNightly
        env:
          PULL_REQUEST: 'false'
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          LASTFM_SECRET: ${{ secrets.LASTFM_SECRET }}

      - name: Rename APK
        if: steps.check.outputs.skip == 'false'
        run: mv app/build/outputs/apk/universal/nightly/*.apk app/build/outputs/apk/universal/nightly/ArchiveTune-Nightly.apk

      - name: Setup Bun
        if: steps.check.outputs.skip == 'false'
        uses: oven-sh/setup-bun@v1

      - name: Generate changelog
        if: steps.check.outputs.skip == 'false'
        id: changelog
        run: |
          bun run scripts/generate-changelog.ts
          {
            echo "changelog<<EOF"
            cat changelog.md
            echo "EOF"
          } >> $GITHUB_OUTPUT
        env:
          LAST_SHA: ${{ steps.read_info.outputs.last_sha }}
          LAST_REPO: ${{ steps.read_info.outputs.last_repo }}
          LAST_BRANCH: dev

      - name: Get Date
        if: steps.check.outputs.skip == 'false'
        id: date
        run: echo "date=$(date +'%Y/%m/%d')" >> $GITHUB_OUTPUT

      - name: Get Time
        if: steps.check.outputs.skip == 'false'
        id: time
        run: echo "time=$(date +'%I:%M:%S %p')" >> $GITHUB_OUTPUT

      - name: Create nightly release
        if: steps.check.outputs.skip == 'false'
        uses: softprops/action-gh-release@v2.5.0
        with:
          repository: sang765/ArchiveTune-Nightly
          tag_name: ${{ env.NEW_VERSION }}
          name: ${{ env.NEW_VERSION }}
          body: |
            Release **ArchiveTune Nightly** artifact, generated on **${{ steps.date.outputs.date }} - ${{ steps.time.outputs.time }} (UTC +0)**

            ${{ steps.changelog.outputs.changelog }}
          files: |
            app/build/outputs/apk/universal/nightly/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Update history
        if: steps.check.outputs.skip == 'false'
        run: |
          LATEST_SHA=$(git rev-parse --short=7 HEAD)
          LATEST_MESSAGE=$(git log --oneline -1 | cut -d' ' -f2-)
          git clone https://${{ secrets.PAT_TOKEN }}@github.com/sang765/ArchiveTune-Nightly.git /tmp/nightly
          cd /tmp/nightly
          if [ ! -f history/commit.json ]; then
            jq -n --arg sha "$LATEST_SHA" --arg msg "$LATEST_MESSAGE" '{commit: {repository: "koiverse/ArchiveTune", branch: "dev", sha: $sha, message: $msg}}' > history/commit.json
          else
            jq --arg sha "$LATEST_SHA" --arg msg "$LATEST_MESSAGE" '.commit.sha = $sha | .commit.message = $msg' history/commit.json > history/commit_temp.json
            mv history/commit_temp.json history/commit.json
          fi
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add history/commit.json
          git commit -m "Update history/commit.json after nightly release https://github.com/sang765/ArchiveTune-Nightly/releases/tag/${{ env.NEW_VERSION }}"
          git push

      - name: Notify on failure
        if: failure()
        run: |
          echo "Build failed on $(date)"
