name: Nightly Build

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          repository: koiverse/ArchiveTune
          ref: dev

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Update version name for nightly build
        run: sed -i 's/versionName = "12.4.6"/versionName = "N'$(date +%Y%m%d)'"/' app/build.gradle.kts

      - name: Update app name and package for nightly build
        run: |
          sed -i 's/applicationIdSuffix = ".debug"/applicationIdSuffix = ".nightly"/' app/build.gradle.kts
          sed -i 's/ArchiveTune Debug/ArchiveTune Nightly/' app/src/debug/res/values/app_name.xml
          sed -i '/buildTypes {/a\        nightly {\n            initWith debug\n        }' app/build.gradle.kts

      - name: Build nightly APKs
        run: ./gradlew assembleArm64Nightly assembleArmeabiNightly assembleUniversalNightly

      - name: Generate changelog
        run: git log --oneline --since="1 day ago" > changelog.txt

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: nightly-apks
          path: |
            app/build/outputs/apk/**/nightly/*.apk
            changelog.txt

      - name: Notify on failure
        if: failure()
        run: |
          echo "Build failed on $(date)"